<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">

    <link rel="shortcut icon" href="/favicon.ico?1">
    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Lua Environments | Notes</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Lua Environments" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Environments Tutorial lua-users home wiki" />
<meta property="og:description" content="Environments Tutorial lua-users home wiki" />
<link rel="canonical" href="http://localhost:4000/docs/lua_environments/" />
<meta property="og:url" content="http://localhost:4000/docs/lua_environments/" />
<meta property="og:site_name" content="Notes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-18T11:43:34+02:00" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/docs/lua_environments/","headline":"Lua Environments","dateModified":"2019-04-18T11:43:34+02:00","datePublished":"2019-04-18T11:43:34+02:00","description":"Environments Tutorial lua-users home wiki","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="canonical" href="http://localhost:4000/docs/lua_environments/">
    <link rel="alternate" type="application/rss+xml" title="Notes" href="http://localhost:4000/feed.xml" />
</head>


<body>

    <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container navbar-container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
            <a class="navbar-brand" href="/">
                <span><img src="/img/logonav.png" alt="Logo"></span> Notes
            </a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li ><a href="/blog/2017/02/01/welcome-to-jekyll/">Blog</a></li>
                
            </ul>
            <div class="navbar-right">
                <form class="navbar-form navbar-left">
                    <div class="form-group has-feedback">
                        <input id="search-box" type="search" class="form-control" placeholder="Search...">
                        <i class="fa fa-search form-control-feedback"></i>
                    </div>
                </form>
                <ul class="nav navbar-nav">
                    <li><a href=""><i class="fa fa-github" aria-hidden="true"></i></a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>


    <div class="page-content">
        <div class="wrapper">
            <div class="container">
    <div class="row">
        <div class="col-md-4">
          <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
  
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-1" aria-expanded="false" aria-controls="collapse-1">
            Notes
          </a>
        </h4>
      </div>
      
      
      <div class="panel-collapse collapse" id="collapse-1" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          
            
            
            <a class="list-group-item " href="/docs/home/">Welcome to Notes</a>
          
            
            
            <a class="list-group-item " href="/docs/cheatsheet/">Markdown Cheatsheet</a>
          
        </div>
      </div>
    </div>
  
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-2" aria-expanded="false" aria-controls="collapse-2">
            Jekyll
          </a>
        </h4>
      </div>
      
      
      <div class="panel-collapse collapse" id="collapse-2" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          
            
            
            <a class="list-group-item " href="/docs/intro/">Intro to Jekyll</a>
          
            
            
            <a class="list-group-item " href=""></a>
          
        </div>
      </div>
    </div>
  
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-3" aria-expanded="false" aria-controls="collapse-3">
            Github
          </a>
        </h4>
      </div>
      
      
      <div class="panel-collapse collapse" id="collapse-3" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          
            
            
            <a class="list-group-item " href="/docs/github_intro/">Github Notes</a>
          
        </div>
      </div>
    </div>
  
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-4" aria-expanded="false" aria-controls="collapse-4">
            Sketching
          </a>
        </h4>
      </div>
      
      
      <div class="panel-collapse collapse" id="collapse-4" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          
            
            
            <a class="list-group-item " href="/docs/sketch/">Sketching Youtube tutorial collections</a>
          
        </div>
      </div>
    </div>
  
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-5" aria-expanded="false" aria-controls="collapse-5">
            Lua
          </a>
        </h4>
      </div>
      
      
      <div class="panel-collapse" id="collapse-5" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          
            
            
            <a class="list-group-item " href="/docs/lua_dataTypes/">Lua Data Types</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_assignment/">Lua Assignment</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_numbers/">Lua Numbers</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_strings/">Lua Strings</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_operators/">Lua Operators</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_controlstructure/">Lua Control Structures</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_tables/">Lua Tables</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_function/">Lua Functions</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_scope/">Lua Scope</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_metamethods/">Lua Metamethods</a>
          
            
            
            <a class="list-group-item active" href="/docs/lua_environments/">Lua Environments</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_modules/">Lua Modules</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_objects/">Lua Objects</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_patterns/">Lua Patterns</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_coroutines/">Lua Coroutines</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_iterators/">lua iterators</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_garbage_collection/">Lua Garbage Collection</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_weekTables/">Lua Weak tables</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_for_loop/">Lua For Loop</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_inheritance/">Lua inheritance</a>
          
        </div>
      </div>
    </div>
  
</div>

        </div>

        <div class="col-md-8">
            <h1>Lua Environments</h1>
            <div id="markdown-content-container"><p>Environments Tutorial</p>

<p>lua-users home
	wiki</p>

<p>Unlike local variables, which are stored in a special data structure in the interpreter, global variables are just stored in a table. A useful feature in Lua is the ability to change this table per-function, so the function sees a different set of global variables.</p>

<p>The default global table is stored inside itself under the key “_G”, this is useful if you want to get an actual reference to it.</p>

<p>The way environments work in Lua 5.2 is very different from 5.1. Both ways will be explained here.</p>

<p>Environments in Lua 5.2</p>

<p>A function’s environment is stored in an upvalue, named _ENV. As an example, here’s a function that sets its environment to a custom one and uses variables from it:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>print(_ENV == _G) -- prints true, since the default _ENV is set to the global table

a = 1

local function f(t)
  local print = print -- since we will change the environment, standard functions will not be visible

  local _ENV = t -- change the environment. without the local, this would change the environment for the entire chunk

  print(getmetatable) -- prints nil, since global variables (including the standard functions) are not in the new env
  
  a = 2 -- create a new entry in t, doesn't touch the original "a" global
  b = 3 -- create a new entry in t
end

local t = {}
f(t)

print(a, b) --&gt; 1 nil
print(t.a, t.b) --&gt; 2 3
</code></pre></div></div>

<p>When loading a chunk, the top-level function gets a new _ENV upvalue, and any nested functions inside it can see it. You can pretend that when loading works something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local _ENV = _G
return function (...) -- this function is what's returned from load
  -- code you passed to load goes here, with all global variable names replaced with _ENV lookups
  -- so, for example "a = b" becomes "_ENV.a = _ENV.b" if neither a nor b were declared local
end
</code></pre></div></div>

<p>Now you can see that _ENV is an ordinary local variable, how all the functions have access to the _ENV, and why if one function changes _ENV all other functions in the loaded chunks will see the change. That’s why if you want a function to only change its own environment, you need to make a new _ENV local that shadows the original one.</p>

<p>In most cases, you don’t need to use environments, unless you want to sandbox a loaded chunk, to give it convenient access to certain functions by making them look global, or to prevent it from seeing unsafe functions for security reasons. This is why 5.2’s load function takes a parameter that lets you set the chunk’s _ENV to a custom table, instead of _G.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local sandbox_env = {
  print = print,
}

local chunk = load("print('inside sandbox'); os.execute('echo unsafe')", "sandbox string", "bt", sandbox_env)

chunk() -- prevents os.execute from being called, instead raises an error saying that os is nil
</code></pre></div></div>

<p>If you actually want to make a sandbox to run untrusted code, remember that it’s easy to overlook a lot of things that can be exploited, and that you would need some kind of way to limit CPU usage and memory.</p>

<p>Environments in Lua 5.1</p>

<p>In Lua 5.1, environments are their own thing, not related to locals or upvalues. Instead, each function has an environment table associated with it, that can be manipulated with the getfenv/setfenv standard functions.</p>

<p>getfenv and setfenv both take a function or stack level (where 1 is the current function, 2 is the function that called the current function, etc.). setfenv has a second parameter that takes the new env table, and getfenv returns the functions’s current env table.</p>

<p>The previous example rewritten for 5.1:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>print(getfenv(1) == _G) -- prints true, since the default env is set to the global table

a = 1

local function f(t)
  local print = print -- since we will change the environment, standard functions will not be visible

  setfenv(1, t) -- change the environment

  print(getmetatable) -- prints nil, since global variables (including the standard functions) are not in the new env
  
  a = 2 -- create a new entry in t, doesn't touch the original "a" global
  b = 3 -- create a new entry in t
end

local t = {}
f(t)

print(a, b) --&gt; 1 nil
print(t.a, t.b) --&gt; 2 3
</code></pre></div></div>

<p>And the sandbox example rewritten for 5.1:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local sandbox_env = {
  print = print,
}

local chunk = loadstring("print('inside sandbox'); os.execute('echo unsafe')")
setfenv(chunk, sandbox_env)

chunk() -- prevents os.execute from being called, instead raises an error saying that os is nil
</code></pre></div></div>

<p>The 5.1 way is sometimes considered simpler and more versatile, but it also requires special treatment of environments (instead of using the existing local variable system). Also, the 5.2 way is designed with the idea that a function’s environment is supposed to be private, instead of being accessible from everywhere without the debug library, so it can be considered safer.
RecentChanges · preferences
edit · history
Last edited June 25, 2014 11:48 pm GMT (diff)</p>
</div>
            <div style="clear:both;">
              <p class="text-center">
                <br />
                
              </p>
            </div>
            <hr>
            





  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  
    <ul class="pager">
      
        
        
        <li class="previous">
          <a href="/docs/lua_metamethods/">
            <span aria-hidden="true">&larr;</span> Previous
          </a>
        </li>
      

      
        
        
        <li class="next">
          <a href="/docs/lua_modules/">
            Next <span aria-hidden="true">&rarr;</span>
          </a>
        </li>
      
      </ul>
    <div class="clear"></div>
    

        </div>

    </div>
</div>

        </div>
    </div>

    <footer class="footer">
    <div class="container">

        <p class="text-center">
            Notes 2019 |
            Powered by <a href="https://github.com/aksakalli/jekyll-doc-theme">Jekyll Doc Theme</a>
        </p>
        <!-- <p class="text-muted">Place sticky footer content here.</p> -->
    </div>
</footer>

    <script>
  var baseurl = ''
</script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="/js/bootstrap.min.js "></script>
<script src="/js/typeahead.bundle.min.js "></script>

<script src="/js/main.js "></script>

</body>

</html>
