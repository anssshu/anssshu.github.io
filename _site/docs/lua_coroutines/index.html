<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">

    <link rel="shortcut icon" href="/favicon.ico?1">
    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Lua Coroutines | Notes</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Lua Coroutines" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Coroutines Tutorial lua-users home wiki" />
<meta property="og:description" content="Coroutines Tutorial lua-users home wiki" />
<link rel="canonical" href="http://localhost:4000/docs/lua_coroutines/" />
<meta property="og:url" content="http://localhost:4000/docs/lua_coroutines/" />
<meta property="og:site_name" content="Notes" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-18T11:43:34+02:00" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/docs/lua_coroutines/","headline":"Lua Coroutines","dateModified":"2019-04-18T11:43:34+02:00","datePublished":"2019-04-18T11:43:34+02:00","description":"Coroutines Tutorial lua-users home wiki","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="canonical" href="http://localhost:4000/docs/lua_coroutines/">
    <link rel="alternate" type="application/rss+xml" title="Notes" href="http://localhost:4000/feed.xml" />
</head>


<body>

    <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container navbar-container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
            <a class="navbar-brand" href="/">
                <span><img src="/img/logonav.png" alt="Logo"></span> Notes
            </a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li ><a href="/blog/2017/02/01/welcome-to-jekyll/">Blog</a></li>
                
            </ul>
            <div class="navbar-right">
                <form class="navbar-form navbar-left">
                    <div class="form-group has-feedback">
                        <input id="search-box" type="search" class="form-control" placeholder="Search...">
                        <i class="fa fa-search form-control-feedback"></i>
                    </div>
                </form>
                <ul class="nav navbar-nav">
                    <li><a href=""><i class="fa fa-github" aria-hidden="true"></i></a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>


    <div class="page-content">
        <div class="wrapper">
            <div class="container">
    <div class="row">
        <div class="col-md-4">
          <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
  
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-1" aria-expanded="false" aria-controls="collapse-1">
            Notes
          </a>
        </h4>
      </div>
      
      
      <div class="panel-collapse collapse" id="collapse-1" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          
            
            
            <a class="list-group-item " href="/docs/home/">Welcome to Notes</a>
          
            
            
            <a class="list-group-item " href="/docs/cheatsheet/">Markdown Cheatsheet</a>
          
        </div>
      </div>
    </div>
  
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-2" aria-expanded="false" aria-controls="collapse-2">
            Jekyll
          </a>
        </h4>
      </div>
      
      
      <div class="panel-collapse collapse" id="collapse-2" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          
            
            
            <a class="list-group-item " href="/docs/intro/">Intro to Jekyll</a>
          
            
            
            <a class="list-group-item " href=""></a>
          
        </div>
      </div>
    </div>
  
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-3" aria-expanded="false" aria-controls="collapse-3">
            Github
          </a>
        </h4>
      </div>
      
      
      <div class="panel-collapse collapse" id="collapse-3" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          
            
            
            <a class="list-group-item " href="/docs/github_intro/">Github Notes</a>
          
        </div>
      </div>
    </div>
  
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-4" aria-expanded="false" aria-controls="collapse-4">
            Sketching
          </a>
        </h4>
      </div>
      
      
      <div class="panel-collapse collapse" id="collapse-4" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          
            
            
            <a class="list-group-item " href="/docs/sketch/">Sketching Youtube tutorial collections</a>
          
        </div>
      </div>
    </div>
  
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-5" aria-expanded="false" aria-controls="collapse-5">
            Lua
          </a>
        </h4>
      </div>
      
      
      <div class="panel-collapse" id="collapse-5" role="tabpanel" aria-label="Side Navigation">
        <div class="list-group">
          
            
            
            <a class="list-group-item " href="/docs/lua_dataTypes/">Lua Data Types</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_assignment/">Lua Assignment</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_numbers/">Lua Numbers</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_strings/">Lua Strings</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_operators/">Lua Operators</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_controlstructure/">Lua Control Structures</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_tables/">Lua Tables</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_function/">Lua Functions</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_scope/">Lua Scope</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_metamethods/">Lua Metamethods</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_environments/">Lua Environments</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_modules/">Lua Modules</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_objects/">Lua Objects</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_patterns/">Lua Patterns</a>
          
            
            
            <a class="list-group-item active" href="/docs/lua_coroutines/">Lua Coroutines</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_iterators/">lua iterators</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_garbage_collection/">Lua Garbage Collection</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_weekTables/">Lua Weak tables</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_for_loop/">Lua For Loop</a>
          
            
            
            <a class="list-group-item " href="/docs/lua_inheritance/">Lua inheritance</a>
          
        </div>
      </div>
    </div>
  
</div>

        </div>

        <div class="col-md-8">
            <h1>Lua Coroutines</h1>
            <div id="markdown-content-container"><p>Coroutines Tutorial</p>

<p>lua-users home
	wiki</p>

<p>What are coroutines?</p>

<p>Coroutines allow us to execute several tasks at once. This is done in a controlled manner by passing control to each routine and waiting until the routine says it has finished. We can reenter the routine to continue at a later time and by doing this repeatedly we achieve multi-tasking.</p>

<p>Coroutines are described in sections 2.11 and 5.2 of the Reference Manual. [1] [2]</p>

<p>Multi-threading</p>

<p>Each task runs in a thread which is separate from the other threads. Having several tasks running at once is often called multi-threading. Because there is more than one thread running at once our application is said to be multi-threaded.</p>

<p>There are different ways in which multi-threading can be implemented. Some systems allocate a fixed amount of time to each thread and take control away when the time is up, passing control on to the next thread etc. This is called pre-emptive multi-threading. In this case each of the threads does not need to worry about how much time it occupies, it is more concerned with its own function.</p>

<p>In other systems, a thread is concerned with how long it is taking. The thread knows it must pass control to other threads so that they can function as well. This is called cooperative, or collaborative multi-threading. Here, all of the threads are collaborating together to allow the application to operate properly. This is the type of multi-tasking that Lua’s coroutines use.</p>

<p>Coroutines in Lua are not operating system threads or processes. Coroutines are blocks of Lua code which are created within Lua, and have their own flow of control like threads. Only one coroutine ever runs at a time, and it runs until it activates another coroutine, or yields (returns to the coroutine that invoked it). Coroutines are a way to express multiple cooperating threads of control in a convenient and natural way, but do not execute in parallel, and thus gain no performance benefit from multiple CPU’s. However, since coroutines switch much faster than operating system threads and do not typically require complex and sometimes expensive locking mechanisms, using coroutines is typically faster than the equivalent program using full OS threads.</p>

<p>Yielding</p>

<p>In order for multiple coroutines to share execution they must stop executing (after performing a sensible amount of processing) and pass control to another thread. This act of submission is called yielding. Coroutines explicitly call a Lua function coroutine.yield(), which is similar to using return in functions. What differentiates yielding from function returns is that at a later point we can reenter the thread and carry on where we left off. When you exit a function scope using return the scope is destroyed and we cannot reenter it, e.g.,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; function foo(x)
&gt;&gt;  if x&gt;3 then return true end  -- we can exit the function before the end if need be
&gt;&gt;  return false                 -- return a value at the end of the function (optional)
&gt;&gt; end
&gt; = foo(1)
false
&gt; = foo(100)                     -- different exit point
true
</code></pre></div></div>

<p>Simple usage</p>

<p>To create a coroutine we must have function which represents it, e.g.,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; function foo()
&gt;&gt;   print("foo", 1)
&gt;&gt;   coroutine.yield()
&gt;&gt;   print("foo", 2)
&gt;&gt; end
&gt;
</code></pre></div></div>

<p>We create a coroutine using the coroutine.create(fn) function. We pass it an entry point for the thread which is a Lua function. The object returned by Lua is a thread:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; co = coroutine.create(foo) -- create a coroutine with foo as the entry
&gt; = type(co)                 -- display the type of object "co"
thread
</code></pre></div></div>

<p>We can find out what state the thread is in using the coroutine.status() function, e.g.,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; = coroutine.status(co)
suspended
</code></pre></div></div>

<p>The state suspended means that the thread is alive, and as you would expect, not doing anything. Note that when we created the thread it did not start executing. To start the thread we use the coroutine.resume() function. Lua will enter the thread and leave when the thread yields.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; = coroutine.resume(co)
foo     1
true
</code></pre></div></div>

<p>The coroutine.resume() function returns the error status of the resume call. The output acknowledges that we entered the function foo and then exited with no errors. Now is the interesting bit. With a function we would not be able to carry on where we left off, but with coroutines we can resume again:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; = coroutine.resume(co)
foo     2
true
</code></pre></div></div>

<p>We can see we executed the line after the yield in foo and again returned without error. However, if we look at the status we can see that we exited the function foo and the coroutine terminated.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; = coroutine.status(co)
dead
</code></pre></div></div>

<p>If we try to resume again a pair of values is returned: an error flag and an error message:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; = coroutine.resume(co)
false   cannot resume dead coroutine
</code></pre></div></div>

<p>Once a coroutine exits or returns like a function it cannot be resumed.</p>

<p>More details</p>

<p>The following is a more complicated example demonstrating some important features of coroutines.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; function odd(x)
&gt;&gt;   print('A: odd', x)
&gt;&gt;   coroutine.yield(x)
&gt;&gt;   print('B: odd', x)
&gt;&gt; end
&gt;
&gt; function even(x)
&gt;&gt;   print('C: even', x)
&gt;&gt;   if x==2 then return x end
&gt;&gt;   print('D: even ', x)
&gt;&gt; end
&gt;
&gt; co = coroutine.create(
&gt;&gt;   function (x)
&gt;&gt;     for i=1,x do
&gt;&gt;       if i==3 then coroutine.yield(-1) end
&gt;&gt;       if i % 2 == 0 then even(i) else odd(i) end
&gt;&gt;     end
&gt;&gt;   end)
&gt;
&gt; count = 1
&gt; while coroutine.status(co) ~= 'dead' do
&gt;&gt;   print('----', count) ; count = count+1
&gt;&gt;   errorfree, value = coroutine.resume(co, 5)
&gt;&gt;   print('E: errorfree, value, status', errorfree, value, coroutine.status(co))
&gt;&gt; end
----    1
A: odd  1
E: errorfree, value, status     true    1       suspended
----    2
B: odd  1
C: even 2
E: errorfree, value, status     true    -1      suspended
----    3
A: odd  3
E: errorfree, value, status     true    3       suspended
----    4
B: odd  3
C: even 4
D: even         4
A: odd  5
E: errorfree, value, status     true    5       suspended
----    5
B: odd  5
E: errorfree, value, status     true    nil     dead
&gt;
</code></pre></div></div>

<p>Basically we have a for loop which calls two functions: odd() when it encounters an odd number and even() on even numbers. The output may be a little difficult to digest so we will study the outer loops, counted by count, one at a time. Comments have been added.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>----    1
A: odd  1       -- yield from odd()
E: errorfree, value, status     true    1       suspended
</code></pre></div></div>

<p>In loop one we call our coroutine using coroutine.resume(co, 5). The first time it is called we enter the for loop in the coroutine function. Note that the function odd(), which is called by our coroutine function yields. You do not have to yield in the coroutine function. This is an important and useful feature. We return value of 1 with the yield.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>----    2
B: odd  1       -- resume in odd with the values we left on the yield
C: even 2       -- call even and exit prematurely
E: errorfree, value, status     true    -1      suspended  -- yield in for loop
</code></pre></div></div>

<p>In loop 2, the main for loop yields and suspends the coroutine. The point to note here is that we can yield anywhere. We do not have to keep yielding from one point in our coroutine. We return -1 with the yield.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>----    3
A: odd  3       -- odd() yields again after resuming in for loop
E: errorfree, value, status     true    3       suspended
</code></pre></div></div>

<p>We resume the coroutine in the for loop and when odd() is called it yields again.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>----    4
B: odd  3       -- resume in odd(), variable values retained
C: even 4       -- even called()
D: even 4       -- no return in even() this time
A: odd  5       -- odd() called and a yield
E: errorfree, value, status     true    5       suspended
</code></pre></div></div>

<p>In loop 4, we resume in odd() where we left off. Note that the variable values are preserved. The scope of the odd() function is preserved during a coroutine suspend. We traverse to the end of even(), this time exiting at the end of the function. In either case, when we exit a function without using coroutine.yield(), the scope and all its variables are destroyed. Only on a yield can we resume.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>----    5
B: odd  5       -- odd called again
E: errorfree, value, status     true    nil     dead  -- for loop terminates
&gt;
</code></pre></div></div>

<p>Once again we resume in odd(). This time the main for loop reaches the limit of 5 we passed into the coroutine. The value of 5 and the for loop state were preserved throughout the execution of the coroutine. A coroutine preserves its own stack and state while in existance. When we exit our coroutine function it dies and we can no longer use it.</p>

<p>RecentChanges · preferences
edit · history
Last edited January 6, 2015 7:26 am GMT (diff)</p>
</div>
            <div style="clear:both;">
              <p class="text-center">
                <br />
                
              </p>
            </div>
            <hr>
            





  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  
    <ul class="pager">
      
        
        
        <li class="previous">
          <a href="/docs/lua_patterns/">
            <span aria-hidden="true">&larr;</span> Previous
          </a>
        </li>
      

      
        
        
        <li class="next">
          <a href="/docs/lua_iterators/">
            Next <span aria-hidden="true">&rarr;</span>
          </a>
        </li>
      
      </ul>
    <div class="clear"></div>
    

        </div>

    </div>
</div>

        </div>
    </div>

    <footer class="footer">
    <div class="container">

        <p class="text-center">
            Notes 2019 |
            Powered by <a href="https://github.com/aksakalli/jekyll-doc-theme">Jekyll Doc Theme</a>
        </p>
        <!-- <p class="text-muted">Place sticky footer content here.</p> -->
    </div>
</footer>

    <script>
  var baseurl = ''
</script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="/js/bootstrap.min.js "></script>
<script src="/js/typeahead.bundle.min.js "></script>

<script src="/js/main.js "></script>

</body>

</html>
